# summary

根据当前会话中的修改或任务，生成一份**简短的结构化摘要**。

- **摘要模式下的行为**（当用户 @ 了某摘要文件，或本会话在围绕摘要/计划进行时）：
  - **计划优先**：用户说的话默认视为**计划**（记入摘要/待办），不是立即执行指令。Agent 只做**记录**或**分析**，不主动执行（不改代码、不跑命令等）。
  - **执行须明确**：只有用户明确表示要执行时（如「执行下一步」「去做」「开始做」「可以做了」等），Agent 才执行；**执行前若不确定，先问**「是否现在执行某某？」待用户确认后再做。

- **若用户 @ 了某摘要文件**（如 `.cursor/summaries/xxx.md`）：
  - **仅读取**：命令后无更新意图时，只读取该文件并展示，不写入；展示后**提示**用户：「若要再次保存/更新此摘要，可在命令后加上更新意图（如 `+` 或中文：更新、保存、补充；英文：update、save、add 等）再 @ 该文件。」
  - **更新并保存**：命令后有更新意图时（如 `+` 或中文：更新、保存、补充；英文：update、save、add 等），**先分析原摘要与本次会话是否有关联**（主题、文件、待办等是否延续或相关）；**若无关联**，不写回该文件，改为**建议用户新建摘要**；有关联则读出该文件，按当前会话更新（打勾、补充待办、追加历史），写回**该文件**（不另建新文件）。
  - **若命令后还有其它文本**：先**分析用户说了什么**，再在生成/更新摘要时体现。可能是：**补充要求**（如「重点写 API 改动」「补充风险点」）、**计划**（如「我计划下一步做某某」「打算先做 A 再做 B」）、**取消/不做**（如「取消 todo 某某」「某某功能不做了」「那个需求先不做了」）等。若为**取消/不做**：在「未完成的计划」中找到对应条目，打勾并注明已取消，或直接从待办中移除；**从待办移除的条目也要在本次「历史」中写明**（如「已取消：某某」）。

## 要求

- **格式**：先写「**会话概要**」（分条列出本会话聊了哪些点、在解决什么问题，每条一行），再分条列出「**变更摘要**」或「**完成项**」；若有未做完的，单独加「**未完成的计划**」；最后加「**涉及/修改的文件**」。
- **涉及/修改的文件**：列出本会话修改或涉及到的文件路径。若有**重命名**或**删除**的文件，单独说明（如「重命名：旧路径 → 新路径」「删除：路径」）。若文件很多，用上级目录 + 文件名规则描述（如前缀、后缀、或「与某某相关的文件」），不必逐条列全。
- **用 git 补全**：仅当项目或子模块下有 `.git` 时，可用 git 获取变更信息（如 `git status`、`git diff --name-status`）以补全「涉及/修改的文件」与重命名/删除；若有 **git submodule**，在仓库根与各子模块根（各自有 `.git` 的）分别执行，再汇总。
- **内容**：只写事实（改了啥、移到哪、更新了哪些引用等），不写「首先」「其次」等套话。
- **语言**：若项目或 .cursorrules 要求中文，则用中文；否则与项目一致。
- **验证**：若有构建/测试/分析通过，在完成项最后一条简要说明。
- **未完成**：根据当前会话中的 TODO、用户说过但未做的需求、或中断的任务，列出未完成的计划；若没有则省略该节。
- **历史时间**：摘要的「历史」小节中，每条标题**必须**为「YYYY-MM-DD HH:mm」或「YYYY-MM-DD HH:mm（说明）」；**禁止只写日期不写时间**（如禁止仅写 `### 2026-01-31`，必须带 `HH:mm`）。

## 保存与更新

- **路径**：保存到 `.cursor/summaries/会话标题.md`。根据会话内容总结出一个简短标题作为文件名（如「用户登录重构」「报表导出优化」）；标题中的空格或特殊字符用 `-` 或 `_` 替换；若无法总结则用 `YYYY-MM-DD-HHmmss` 或 `current.md`。
- **目录**：若 `.cursor/summaries/` 不存在，先创建该目录再写入文件。
- **文件结构**：文件自上而下固定为「**会话概要**」→「当前摘要/完成项」→「未完成的计划」→「**涉及/修改的文件**」→「历史」；更新时先更新会话概要（若本会话主题有延续或变化），再维护完成项、待办与涉及文件，最后在末尾追加历史。
- **首次**：文件不存在则直接写入；未完成的计划用 `- [ ] 条目`。**写入后与「仅读取」一样提示用户**：若要再次读取可 @ 该文件；若要保存/更新可在命令后加上更新意图（如 `+` 或 更新、save 等）再 @ 该文件。
- **更新**：文件已存在则：
  1. **关联判断**：分析原摘要（会话概要、涉及文件、待办等）与本次会话是否有关联；若无关联，不执行下述步骤，改为建议用户新建摘要。
  2. 读出原内容；
  3. **打勾**：按语义/文案匹配本次「完成项」与文件中「未完成的计划」里的 `- [ ]` 条目，匹配到的改为 `- [x]`；无法匹配的完成项记入本次历史即可；
  4. **补充待办**：在「未完成的计划」中追加本次仍待办的事项（`- [ ]`），与已有条目语义相近的合并为一条，不重复；
  5. **历史**：在文件末尾用 `## 历史`，下加 `### YYYY-MM-DD HH:mm` 小节，再列本次「变更摘要」或「完成项」；若有从待办中移除或标记已取消的条目，也一并记入（如「已取消：某某」），最后写回文件。**历史条目标题必须带时间**：格式为 `### YYYY-MM-DD HH:mm` 或 `### YYYY-MM-DD HH:mm（说明）`；新增时使用**当前**日期时间；同一天多次更新可在时间后加简短括号说明。**禁止只写日期**（如禁止 `### 2026-01-31`），必须包含 `HH:mm`。
- **获取当前时间**：通过命令获取时间时，使用环境变量中的时区。先读取 `~/.bashrc` 中的 `TZ`（如 `export TZ=Asia/Shanghai`），在携带该环境的 shell 中执行 `date '+%Y-%m-%d %H:%M'`，得到的结果即用于历史小节的「当前」时间；勿硬编码时区。
- **空会话**：若本次没有任何修改或待办，不新建文件、不覆盖已有文件，仅在回复中说明「本次无变更」。

## 输出示例

```markdown
**会话概要**
- 聊了什么 / 在解决什么问题（点 1）
- 聊了什么 / 在解决什么问题（点 2）
- …

**变更摘要**（或 **完成项**，二选一）
- [范围] 做了什么
- [范围] 做了什么
- 构建/分析已通过

**未完成的计划**
- [ ] [计划/需求] 尚未完成的原因或下一步（无则省略）

**涉及/修改的文件**
- 具体路径（少量时逐条列）
- 若有重命名：`旧路径` → `新路径`；若有删除：`路径`（已删）
- 或：`某目录/` 下 某前缀/后缀/与某某相关的 `*.扩展名`（文件多时用规则描述）
```

保存时未完成项统一用 `- [ ]`，已完成的用 `- [x]`，便于下次更新时打勾。
